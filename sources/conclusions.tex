\section{Conclusion}
\label{sec:ktoctou-conclusion}


Kernel-level TOCTOU vulnerability is severe and widespread among operating system kernels. We learn its memory access pattern by studying real-world samples and develop a fuzzing tool that
effectively finds kernel-level TOCTOU candidates in Windows.

Moreover, we creatively use an Intel hardware feature SMAP to mitigate such vulnerability. To the best of our knowledge, it is the first run-time protection for kernel-level TOCTOU. We test it against real-world vulnerabilities, and it effectively protects the Windows kernel from attacks. We also develop a lightweight hypervisor to confine the system-wide feature SMAP into specific processes. We evaluate the mitigation and lightweight hypervisor with 18 benchmark programs and real-world applications. The performance overhead is acceptable (less than 10\% on average).

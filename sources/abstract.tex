%! TEX root = 'main.tex'
\section{Abstract}

Kernel-level time-of-check-to-time-of-use (TOCTOU) attacks exist wildly in the operating systems, especially Microsoft Windows. Since the Windows graphical subsystem kernel module couples with user-mode libraries and accesses user-mode data structures loosely, double fetches on the same address are not unusual. The kernel inevitably suffers TOCTOU attacks due to data racing between the kernel and userspace.

This paper studies the exploration and mitigation of TOCTOU attacks. Notably, we present \toolname, a fuzzing tool that effectively finds kernel-level TOCTOU candidates and reported our findings to Microsoft. Moreover, we proposed \name, the first run-time mitigation technique on Windows. \name does not require Windows kernel source code or modifying kernel binary. The core of \name is to use Supervisor Mode Access Prevention (SMAP), a hardware feature, to detect kernel access to userspace data. To leverage SMAP, we make the kernel adaptable to recover from the fatal SMAP exceptions. Due to the Windows system's complex nature, we further develop a lightweight hypervisor to confine the system-wide hardware feature SMAP into specific processes to prevent deadlock caused by nested SMAP exceptions. The hypervisor also improves the flexibility and performance of \name. We evaluate \name and the lightweight hypervisor with 18 benchmark programs and real-world applications. \name prevents the race condition from happening and blocks the attacks successfully. Our evaluation results show that \name imposes little extra overhead (less than 10\% on average).


%! TEX root = 'main.tex'
\section{Abstract}


%Kernel-level time-of-check-to-time-of-use (TOCTOU) widely exists in operating systems, especially Microsoft Windows. When serving a system call, the kernel inevitably gets parameters from the userspace. Read the same user-mode variable repeatedly may lead to data inconsistency under a race condition between the kernel and userspace. This paper presents \name, an efficient run-time mitigation technique on Windows, to prevent the double fetch behavior without recompiling it from source code or modifying the kernel's binary. The core of \name is to use \texttt{Supervisor Mode Access Prevention (SMAP)}, a hardware feature, to detect kernel access to userspace. To leverage SMAP, \name customized the kernel xxxxx. We investigated and found one, if not the only solution, to make the system recover from the fatal SMAP exception. \hb{Dont understand what is the purpose of this sentence }
%We further develop a new technique, a lightweight hypervisor where one process contains a system-wide CPU feature, to improve the flexibility and performance of \name. We evaluate \name and lightweight hypervisor with 18 benchmark programs and real-world applications. Our evaluation results show that \name impose little extra overhead(less than 10 \% on average).


Kernel-level time-of-check-to-time-of-use (TOCTOU) widely exists in operating systems, especially Microsoft Windows. When serving a system call, the kernel inevitably gets parameters from the userspace. Read the same user-mode variable repeatedly may lead to data inconsistency under a race condition between the kernel and userspace.  We notice the Windows graphical subsystem kernel module couples with user-mode libraries, and it accesses user-mode data structures loosely, among which double fetches on the same address are not unusual. To find the bugs with the typical memory-access pattern, we develop a fuzzing tool that effectively finds kernel-level TOCTOU candidates, and we reported our findings to Microsoft. 

Furthermore, to mitigate such vulnerabilities, we present \name, the first run-time mitigation technique on Windows. \name does not require Windows kernel source code or modifying kernel binary. The core of \name is to use Supervisor Mode Access Prevention (SMAP), a hardware feature, to detect kernel access to userspace data. To leverage SMAP, we make the kernel adaptable to recover from the fatal SMAP exceptions. Due to the Windows system's complex nature, we further develop a lightweight hypervisor to confine the system-wide hardware feature SMAP into specific processes to prevent deadlock caused by nested SMAP exceptions. The hypervisor also improves the flexibility and performance of \name. We evaluate \name and the lightweight hypervisor with 18 benchmark programs and real-world applications. Our evaluation results show that \name imposes little extra overhead(less than 10\% on average).


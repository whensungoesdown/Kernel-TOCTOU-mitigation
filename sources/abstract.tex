%! TEX root = 'main.tex'
\section{Abstract}

%Time-of-check-to-time-of-use (TOCTOU) attacks have been a key threat to systems security. It is a long-history issue with many forms. In this paper, we address this issue that happens in the operating system kernel. If the kernel reference a user-mode variable more than one time during a system call. It is possible that a malicious user changes the variable deliberately. So that the kernel lost data consistency. The value differences could lead to a serious vulnerability such as buffer overflow.  We examined the root cause of real-world cases. And we present the first run-time mitigation for kernel TOCTOU vulnerability. We take advantage of an Intel processor feature Supervisor Mode Access Prevention (SMAP). The CPU will raise an exception when the kernel access user space. It enables us the ability to identify the kernel's dangerous behavior with low-overhead. We take over the page fault handler to handle the exception. When it comes, we set the page's attribute so that it becomes a kernel page for the rest of the system call.  Thus, no user code can access that variable. The related page sharing issues also solved with a novel solution. We also develop a lightweight hypervisor. Its purpose is to contain a system-wide hardware feather within a particular process.  This makes our mitigation more flexible and practical. Because of the hardware feature and the hypervisor, the performance overhead is modest. We test it with non-trivial applications. On average, it's below 10\%

Kernel-level time-of-check-to-time-of-use (TOCTOU) widely exists in operating systems, especially Microsoft Windows. When serving a system call, the kernel inevitably gets parameters from the userspace. Read the same user-mode variable repeatedly may lead to data inconsistency under a race condition between the kernel and userspace. We bring the first run-time mitigation on Windows to protect its double fetch behavior without recompiling it from source code or modifying the kernel's binary. We leverage an Intel CPU feature, Supervisor Mode Access Prevention (SMAP), to notify us immediately when the kernel access userspace. A novel mitigation method protects the accessed user-mode pages from other user-mode threads.
Moreover, we provide a lightweight hypervisor to contain a system-wide CPU feather within one process. The hypervisor makes our mitigation more flexible and achieves a low overhead. We also discuss a novel technique to discover similar TOCTOU vulnerabilities and the outcome we obtained on the Windows operating system. We evaluate our mitigation and hypervisor with benchmark programs and real-world applications. The performance overhead, on average, is less than 10\%.
